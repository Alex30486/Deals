import { useState, useEffect, useRef } from "react";

// ─── INTEGRATED ACTOR CONFIGURATION ──────────────────────────────────────────
const PIPELINE_NODES = [
    { id: "maxcopell~zillow-zip-search", label: "SEARCH", icon: "fa-location-crosshairs", color: "text-blue-400", desc: "Extracting ZPIDs" },
    { id: "18TsPuKUHiy49Y10E", label: "ENRICH", icon: "fa-database", color: "text-yellow-400", desc: "Tax & DOM Data" },
    { id: "CLAUDE_SONNET", label: "SCORE", icon: "fa-brain", color: "text-emerald-400", desc: "Thesis Generation" }
];

const App = () => {
    const [location, setLocation] = useState('');
    const [isHunting, setIsHunting] = useState(false);
    const [activeStep, setActiveStep] = useState(-1);
    const [logs, setLogs] = useState([]);
    const [results, setResults] = useState([]);

    // Live terminal log handler
    const addLog = (text, type = 'info') => {
        const colors = { info: 'text-gray-500', success: 'text-emerald-400', warn: 'text-yellow-500', ai: 'text-blue-400' };
        setLogs(prev => [{ text, color: colors[type], time: new Date().toLocaleTimeString(), id: Date.now() }, ...prev]);
    };

    const runHunt = async () => {
        if(!location) return alert("System requires target location coordinates.");
        
        setIsHunting(true);
        setResults([]);
        setLogs([]);

        try {
            // STAGE 1: Zillow Search Scraper
            setActiveStep(0);
            addLog(`Initializing node ${PIPELINE_NODES[0].id}...`, 'info');
            await new Promise(r => setTimeout(r, 1500)); // Simulating Apify Actor run-sync
            addLog(`Success: 24 ZPIDs cached for ${location}`, 'success');

            // STAGE 2: Property Detail Enrichment
            setActiveStep(1);
            addLog(`Routing ZPIDs to enrichment node: ${PIPELINE_NODES[1].id}`, 'info');
            await new Promise(r => setTimeout(r, 2000));
            addLog(`Dataset enriched with Tax Records & DOM metrics.`, 'success');

            // STAGE 3: AI Scoring & Investment Thesis
            setActiveStep(2);
            addLog(`Claude AI: Analyzing market variance and seller motivation...`, 'ai');
            await new Promise(r => setTimeout(r, 2000));

            // Integrated Results Logic with AI Thesis
            const deals = [
                { 
                    addr: `1024 ${location} Blvd`, 
                    price: 315000, 
                    zest: 395000, 
                    score: 94, 
                    tags: ["Fix/Flip", "Distressed"], 
                    thesis: "Property listed 15% below zip median. 120+ DOM suggests extreme seller fatigue and high motivation for a quick exit." 
                },
                { 
                    addr: `88 Oak St, ${location}`, 
                    price: 198000, 
                    zest: 260000, 
                    score: 89, 
                    tags: ["Wholesale"], 
                    thesis: "Deep equity discount detected. Tax record analysis shows pre-foreclosure status. Structural assessment recommended." 
                },
                { 
                    addr: `45 River Rd, ${location}`, 
                    price: 520000, 
                    zest: 545000, 
                    score: 71, 
                    tags: ["Rental"], 
                    thesis: "Stable cashflow potential but thin equity margin. AI suggests high-performing school district provides long-term exit stability." 
                }
            ];

            setResults(deals.sort((a,b) => b.score - a.score));
            addLog(`Pipeline complete. 3 high-confidence deals identified.`, 'success');
        } catch (err) {
            addLog(`Pipeline failure: ${err.message}`, 'warn');
        } finally {
            setIsHunting(false);
            setActiveStep(-1);
        }
    };

    return (
        <div className="min-h-screen p-6 md:p-12 flex flex-col bg-[#020b05] text-[#00ff9d] font-mono">
            {/* ... Navigation and Controls ... */}
            
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 flex-grow">
                {/* DEAL CARDS PANEL */}
                <div className="lg:col-span-8 space-y-6">
                    {results.map((deal, i) => (
                        <div key={i} className="border border-emerald-500/20 p-6 bg-black/50 hover:border-emerald-500/50 transition-all">
                            <div className="flex justify-between items-start mb-4">
                                <div>
                                    <div className="flex gap-2 mb-2">
                                        {deal.tags.map(t => <span key={t} className="text-[10px] border border-emerald-500/40 px-2 py-0.5 rounded">{t}</span>)}
                                    </div>
                                    <h3 className="text-xl font-bold text-white uppercase italic">{deal.addr}</h3>
                                </div>
                                <div className="text-right">
                                    <div className="text-2xl font-black">${deal.price.toLocaleString()}</div>
                                    <div className="text-[10px] text-emerald-800 font-bold uppercase">Zestimate: ${deal.zest.toLocaleString()}</div>
                                </div>
                            </div>
                            
                            {/* NEW: AI BRAIN THESIS SECTION */}
                            <div className="border-t border-emerald-500/10 pt-4 mt-4">
                                <div className="text-[9px] text-blue-400 font-bold uppercase tracking-widest mb-2 flex items-center gap-2">
                                    <i className="fa-solid fa-brain"></i> AI Investment Thesis
                                </div>
                                <p className="text-sm text-gray-400 italic leading-relaxed">"{deal.thesis}"</p>
                            </div>
                        </div>
                    ))}
                </div>

                {/* LIVE LOG PANEL */}
                <div className="lg:col-span-4 terminal-glass p-6 rounded border border-emerald-500/10">
                    <div className="text-[10px] font-bold text-emerald-900 uppercase tracking-widest mb-4">System Event Stream</div>
                    <div className="space-y-2 overflow-y-auto h-[500px]">
                        {logs.map(log => (
                            <div key={log.id} className={`${log.color} text-[10px]`}>
                                <span className="opacity-30 mr-2">[{log.time}]</span> {log.text}
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        </div>
    );
};
