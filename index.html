from flask import Flask, jsonify, request
import requests

app = Flask(__name__)

# --- THE GRABBER ---
def get_live_leads(city):
    url = f"https://nominatim.openstreetmap.org/search?q=house+in+{city}&format=json&addressdetails=1&limit=10"
    headers = {'User-Agent': 'Elara_Hunter_v16'}
    try:
        response = requests.get(url, headers=headers)
        data = response.json()
        return [{"address": item.get('display_name').split(',')[0], 
                 "owner": "Property Lead", 
                 "zip": item.get('address', {}).get('postcode', 'N/A')} for item in data]
    except:
        return []

@app.route('/api/scrape')
def scrape():
    city = request.args.get('city', 'Philadelphia')
    return jsonify(get_live_leads(city))

# --- THE FRONTEND ---
@app.route('/')
def index():
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>ELARA v16 | Live Dial</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/dist/vapi.browser.js"></script>
        <style>
            body { background: #020617; color: white; font-family: sans-serif; }
            .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        </style>
    </head>
    <body class="p-10">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-10">
                <div>
                    <h1 class="text-3xl font-black text-blue-500 italic">ELARA <span class="text-white font-light">VOICE</span></h1>
                    <p id="vapi-status" class="text-[10px] uppercase tracking-widest text-slate-500 font-bold mt-1">● AI Agent Standby</p>
                </div>
                <input id="city" type="text" placeholder="Miami, FL" class="bg-slate-900 border-none rounded-full px-6 py-2 text-sm outline-none ring-1 ring-slate-800 focus:ring-blue-500">
                <button onclick="hunt()" class="bg-blue-600 px-6 py-2 rounded-full text-xs font-bold uppercase hover:bg-blue-400 transition">Scrape</button>
            </div>

            <div id="feed" class="grid grid-cols-1 gap-4">
                <p class="text-center opacity-20 py-20 italic">No targets locked. Enter a city above.</p>
            </div>
        </div>

        <script>
            // CONFIG YOUR KEYS HERE
            const vapi = new Vapi('YOUR_VAPI_PUBLIC_KEY'); 
            const ASSISTANT_ID = 'YOUR_ASSISTANT_ID';

            vapi.on('call-start', () => { document.getElementById('vapi-status').innerText = '● CALL IN PROGRESS'; document.getElementById('vapi-status').classList.add('text-red-500'); });
            vapi.on('call-end', () => { document.getElementById('vapi-status').innerText = '● AI Agent Standby'; document.getElementById('vapi-status').classList.remove('text-red-500'); });

            async function hunt() {
                const city = document.getElementById('city').value || 'Philadelphia';
                const res = await fetch('/api/scrape?city=' + city);
                const data = await res.json();
                
                document.getElementById('feed').innerHTML = data.map(l => `
                    <div class="glass p-6 rounded-3xl flex justify-between items-center">
                        <div>
                            <p class="text-[10px] text-blue-400 font-bold uppercase mb-1">${l.zip}</p>
                            <h3 class="font-bold text-lg">${l.address}</h3>
                        </div>
                        <button onclick="startCall('${l.address}')" class="bg-white text-black px-8 py-3 rounded-2xl text-[10px] font-black uppercase hover:bg-blue-500 hover:text-white transition">
                            Call Owner
                        </button>
                    </div>
                `).join('');
            }

            function startCall(address) {
                console.log("Initiating call for: " + address);
                vapi.start(ASSISTANT_ID, {
                    assistantOverrides: {
                        variableValues: { propertyAddress: address }
                    }
                });
            }
        </script>
    </body>
    </html>
    """

if __name__ == '__main__':
    app.run(debug=True, port=5000)
